name: Build Windows Executable using Pixi

on:
  push:
    branches:
      - "**"
    tags:
      - "*"

jobs:
  build:
    #if: false # Temporarily disable this workflow
    runs-on: windows-2025
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      artifact_name: rayforge-${{ steps.set-version.outputs.version }}.zip

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set Version from Git
        id: set-version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${{ github.ref_name }}
          elif git describe --tags >/dev/null 2>&1; then
            VERSION=$(git describe --tags)
          else
            VERSION="v0.0.0-$(git rev-parse --short HEAD)"
          fi
          VERSION_CLEAN=$(echo "$VERSION" | sed 's/[^a-zA-Z0-9.-]/-/g')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_clean=$VERSION_CLEAN" >> $GITHUB_OUTPUT

      - name: Set up MSYS2 and Native Dependencies
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-libvips
            mingw-w64-x86_64-gobject-introspection

      - name: Configure Environment for Pixi
        shell: bash
        run: |
          MSYS2_LOCATION="${{ steps.msys2.outputs.msys2-location }}"

          # 1. Prepend MSYS2 bin directory to the GitHub Actions PATH.
          # This ensures its tools (gcc, pkg-config) are found first.
          echo "Adding $MSYS2_LOCATION/mingw64/bin to PATH"
          echo "$MSYS2_LOCATION/mingw64/bin" >> $GITHUB_PATH

          # 2. Set PKG_CONFIG_PATH for packages that use it (PyGObject).
          echo "Setting PKG_CONFIG_PATH to $MSYS2_LOCATION/mingw64/lib/pkgconfig"
          echo "PKG_CONFIG_PATH=$MSYS2_LOCATION/mingw64/lib/pkgconfig" >> $GITHUB_ENV

          # 3. Force the C/C++ compiler to be the one from MSYS2.
          # This ensures build tools use the MinGW GCC, which knows where to find
          # its own libraries (like libvips). This overrides the MSVC default.
          echo "Setting CC to use MinGW GCC"
          echo "CC=$MSYS2_LOCATION/mingw64/bin/gcc.exe" >> $GITHUB_ENV
          echo "CXX=$MSYS2_LOCATION/mingw64/bin/g++.exe" >> $GITHUB_ENV

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.0
        with:
          cache: true

      - name: Install Dependencies with Pixi
        run: pixi install -e windows-build

      - name: Compile Translations
        run: pixi run -e windows-build compile-translations

      - name: Build Executable
        env:
          MSYS2_PREFIX: ${{ steps.msys2.outputs.msys2-location }}/mingw64
        run: pixi run -e windows-build build-exe ${{ steps.set-version.outputs.version_clean }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rayforge-${{ steps.set-version.outputs.version }}.zip
          path: dist/rayforge-${{ steps.set-version.outputs.version_clean }}.exe
          compression-level: 9

  test-exe:
    name: Test Executable
    needs: build
    runs-on: windows-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
      - name: Test Executable
        shell: bash
        run: |
          EXE_NAME=$(ls rayforge-*.exe)
          ./"$EXE_NAME" --help
