# 连接问题

本页面帮助您诊断和解决 Rayforge 通过串口连接激光机器的问题。

## 快速诊断

### 症状

常见连接问题包括：

- 尝试连接时出现"必须配置端口"错误
- 连接反复失败并重新连接
- 串口未出现在端口列表中
- 尝试打开串口时出现"Permission denied"错误
- 设备似乎已连接但不响应命令

---

## 常见问题和解决方案

### 未检测到串口

**问题：** 串口下拉列表为空或不显示您的设备。

**诊断：**

1. 检查设备是否已开机并通过 USB 连接
2. 尝试拔下并重新插入 USB 电缆
3. 用另一台设备测试 USB 电缆（电缆可能损坏）
4. 尝试计算机上的不同 USB 端口

**解决方案：**

**Linux：**
如果您使用 Snap 版本，您需要授予串口权限：

```bash
sudo snap connect rayforge:serial-port
```

详见 [Snap 权限](snap-permissions)。

对于非 Snap 安装，将您的用户添加到 `dialout` 组：

```bash
sudo usermod -a -G dialout $USER
```

然后注销并重新登录以使更改生效。

**Windows：**
1. 打开设备管理器（Win+X，然后选择设备管理器）
2. 在"端口 (COM 和 LPT)"下查找您的设备
3. 如果看到黄色警告图标，更新或重新安装驱动程序
4. 记下 COM 端口号（例如 COM3）
5. 如果设备根本未列出，USB 电缆或驱动程序可能有故障

**macOS：**
1. 检查系统信息 → USB 以验证设备是否被识别
2. 如果您的控制器使用此芯片组，安装 CH340/CH341 驱动程序
3. 检查 `/dev/tty.usbserial*` 或 `/dev/cu.usbserial*` 设备

### 权限被拒绝错误

**问题：** 尝试连接时出现"Permission denied"或类似错误。

**在 Linux（非 Snap）上：**

您的用户需要在 `dialout` 组（或某些发行版上的 `uucp`）中：

```bash
# 将自己添加到 dialout 组
sudo usermod -a -G dialout $USER

# 验证您在组中（注销/登录后）
groups | grep dialout
```

**重要：** 您必须注销并重新登录（或重启）才能使组更改生效。

**在 Linux（Snap）上：**

授予 snap 串口访问权限：

```bash
sudo snap connect rayforge:serial-port
```

详见 [Snap 权限](snap-permissions) 指南。

**在 Windows 上：**

关闭可能正在使用串口的任何其他应用程序，包括：
- Rayforge 的先前实例
- 串口监视工具
- 其他激光软件
- Arduino IDE 或类似工具

### 选择了错误的串口

**问题：** Rayforge 连接但机器不响应。

**诊断：**

您可能选择了错误的端口，特别是如果您连接了多个 USB 设备。

**解决方案：**

1. 断开所有其他 USB 串口设备
2. 记下 Rayforge 中可用的端口
3. 插入您的激光控制器
4. 刷新端口列表 - 新端口就是您的激光
5. 在 Linux 上，激光控制器通常显示为：
   - `/dev/ttyUSB0`（CH340 芯片组常见）
   - `/dev/ttyACM0`（原生 USB 控制器常见）
6. 在 Windows 上，记下设备管理器中的 COM 端口
7. 避免在 Linux 上选择名为 `/dev/ttyS*` 的端口 - 这些是硬件串口，不是 USB

:::warning 硬件串口
如果您在 Linux 上选择 `/dev/ttyS*` 端口，Rayforge 会警告您，因为这些通常不是基于 USB 的 GRBL 设备。USB 串口使用 `/dev/ttyUSB*` 或 `/dev/ttyACM*`。
:::


### 波特率不正确

**问题：** 连接建立但命令不起作用或产生乱码响应。

**解决方案：**

GRBL 控制器通常使用以下波特率之一：

- **115200**（最常见，GRBL 1.1+）
- **9600**（较旧的 GRBL 版本）
- **250000**（较少见，一些自定义固件）

在 Rayforge 的设备设置中尝试不同的波特率。最常见的是 **115200**。

### 连接反复断开

**问题：** Rayforge 连接成功但不断断开并重新连接。

**可能原因：**

1. **USB 电缆不稳定** - 用已知良好的电缆更换（最好短于 2m）
2. **USB 电源问题** - 尝试不同的 USB 端口，最好在计算机本身而不是集线器上
3. **EMI/干扰** - 使 USB 电缆远离电机线和高压电源
4. **固件问题** - 如可能更新您的 GRBL 固件
5. **USB 端口冲突** - 在 Windows 上，尝试不同的 USB 端口

**故障排除步骤：**

```bash
# 在 Linux 上，连接时监控系统日志：
sudo dmesg -w
```

查找以下消息：
- "USB disconnect" - 表示物理/电缆问题
- "device descriptor read error" - 通常是电源或电缆问题

### 连接后设备不响应

**问题：** 连接状态显示"已连接"但机器不响应命令。

**诊断：**

1. 检查是否选择了正确的固件类型（GRBL vs 其他）
2. 验证机器是否已开机（控制器和电源）
3. 检查机器是否处于报警状态（需要归位或清除报警）

**解决方案：**

尝试在控制台中发送手动命令：

- `?` - 请求状态报告
- `$X` - 清除报警
- `$H` - 归位机器

如果没有响应，请仔细检查波特率和端口选择。

---

## 连接状态消息

Rayforge 显示不同的连接状态：

| 状态         | 含义                         | 操作                             |
| ------------ | ---------------------------- | -------------------------------- |
| **已断开**   | 未连接到任何设备             | 配置端口并连接                   |
| **连接中**   | 正在尝试建立连接             | 等待，或如果卡住则检查配置       |
| **已连接**   | 成功连接并接收状态           | 可以使用                         |
| **错误**     | 连接失败并出现错误           | 检查错误消息以获取详细信息       |
| **休眠**     | 重新连接尝试前等待           | 先前连接失败，5 秒后重试         |

---

## 测试您的连接

### 逐步连接测试

1. **配置机器：**
   - 打开 设置 → 机器
   - 选择或创建机器配置文件
   - 选择正确的驱动程序（GRBL Serial）
   - 选择串口
   - 设置波特率（通常为 115200）

2. **尝试连接：**
   - 点击机器控制面板中的"连接"
   - 观察连接状态指示器

3. **验证通信：**
   - 如果已连接，尝试发送状态查询
   - 机器应报告其位置和状态

4. **测试基本命令：**
   - 如果您的机器有限位开关，尝试归位（`$H`）
   - 或如需要清除报警（`$X`）

### 使用调试日志

Rayforge 包含连接问题的详细日志。要启用调试日志：

```bash
# 从终端带调试日志运行 Rayforge
rayforge --loglevel DEBUG
```

检查日志中的：
- 连接尝试和失败
- 串口数据传输（TX）和接收（RX）
- 带堆栈跟踪的错误消息

---

## 高级故障排除

### 手动检查端口可用性

**Linux：**
```bash
# 列出所有 USB 串口设备
ls -l /dev/ttyUSB* /dev/ttyACM*

# 检查权限
ls -l /dev/ttyUSB0  # 替换为您的端口

# 应显示：crw-rw---- 1 root dialout
# 您需要在 'dialout' 组中

# 手动测试端口
sudo minicom -D /dev/ttyUSB0 -b 115200
```

**Windows：**
```powershell
# 在 PowerShell 中列出 COM 端口
[System.IO.Ports.SerialPort]::getportnames()

# 或使用设备管理器：
# Win + X → 设备管理器 → 端口 (COM 和 LPT)
```

### 固件兼容性

Rayforge 设计用于兼容 GRBL 的固件。确保您的控制器运行：

- **GRBL 1.1**（最常见，推荐）
- **GRBL 0.9**（较旧，可能有功能限制）
- **grblHAL**（现代 GRBL 分支，受支持）

其他固件类型（Marlin、Smoothieware）目前不通过 GRBL 驱动程序支持。

### USB 转串口芯片组

常见芯片组及其驱动程序：

| 芯片组           | Linux      | Windows                  | macOS       |
| ---------------- | ---------- | ------------------------ | ----------- |
| **CH340/CH341**  | 内核驱动   | [CH341SER 驱动](http://www.wch.cn/downloads/) | 需要驱动   |
| **FTDI FT232**   | 内核驱动   | 内置（Windows 10+）      | 内置        |
| **CP2102 (SiLabs)** | 内核驱动 | 内置（Windows 10+）      | 内置        |

---

## 仍有问题？

如果您已尝试上述所有方法但仍无法连接：

1. **检查 GitHub issues** - 可能有人报告了相同的问题
2. **创建详细的 issue 报告**，包含：
   - 操作系统和版本
   - Rayforge 版本（Snap/Flatpak/AppImage/源代码）
   - 控制器板型号和固件版本
   - USB 芯片组（在 Windows 上检查设备管理器或在 Linux 上使用 `lsusb`）
   - 完整的错误消息和调试日志
3. **用另一个应用程序测试** - 尝试用串口终端（minicom、PuTTY、Arduino 串口监视器）连接以验证硬件是否工作

---

## 相关页面

- [Snap 权限](snap-permissions) - Linux Snap 权限设置
- [调试模式](debug) - 启用诊断日志
- [常规设置](../machine/general) - 机器设置指南
- [设备设置](../machine/device) - GRBL 配置参考
