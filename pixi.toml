[workspace]
name = "rayforge"
version = "0.1.0"
channels = ["conda-forge", "bioconda", "msys2", "coastline"]
platforms = ["linux-64"]

[environments]
default = { features = ["app", "test"], solve-group = "default" }
website = { features = ["website"], solve-group = "default" }
build = { features = ["build-tools"], solve-group = "build" }
video = { features = ["video-tools"], solve-group = "video" }

[feature.app.dependencies]
adwaita-icon-theme = "*"
glib = "*"
cairo = "*"
expat = "*"
gettext = "*"
gobject-introspection = "*"
gtk4 = "*"
libheif = "*"
openslide = "*"
poppler = "*"
python = ">=3.11"
librsvg = ">=2.58.4,<3"
svgelements = ">=1.9.6,<2"
scipy = "*"
pycairo = "==1.28.0"
PyOpenGL = "==3.1.10"
PyOpenGL-accelerate = "==3.1.10"
PyGObject = "==3.50.0"
pkg-config = "*"
rust = "*"

[feature.app.pypi-dependencies]
rayforge = { editable = true, path = "." }
aiohttp = "==3.13.3"
asyncudp = "==0.11.0"
blinker = "==1.9.0"
build = "*"
cairosvg = "==2.8.2"
ezdxf = "==1.3.5"
GitPython = "==3.1.44"
platformdirs = "==4.3.6"
pluggy = "==1.6.0"
pyclipper = "==1.3.0.post6"
pypdf = "==6.7.1"
pyserial-asyncio = "==0.6"
pyvips = "==3.0.0"
PyYAML = "==6.0.2"
semver = "==3.0.2"
vtracer = "==0.6.11"
websockets = "==14.2"

[feature.app.target.linux-64.dependencies]
libvips = "*"
xorg-xproto = "*"
xorg-libx11 = "*"
xorg-kbproto = "*"
xorg-xextproto = "*"
xorg-xineramaproto = "*"
xorg-xf86vidmodeproto = "*"
xorg-renderproto = "*"
xorg-inputproto = "*"
xorg-compositeproto = "*"
xorg-damageproto = "*"
xorg-glproto = "*"
xorg-presentproto = "*"
xorg-libxext = "*"
xorg-libxinerama = "*"
xorg-libxrandr = "*"

[feature.build-tools.dependencies]
gettext = "*"

[feature.test.dependencies]
pytest = "*"

[feature.test.pypi-dependencies]
pytest-asyncio = "*"
pytest-mock = "*"
pytest-cov = "*"
pygobject-stubs = "*"
flake8 = "*"
pyflakes = "*"
pyright = "*"
ruff = "*"
pre-commit = "*"

[feature.website.dependencies]
nodejs = ">=22"
[feature.video-tools.dependencies]
ffmpeg = "*"
python = ">=3.11"

[feature.video-tools.pypi-dependencies]
pillow = "*"

[tool.pixi]
workdir = "."

[tasks]
pre-commit-install = "pre-commit install"
flake = "flake8 --ignore=E127,E128,E121,E123,E126,E203,E226,E24,E704,W503,W504 --builtins=_ rayforge tests"
pyflakes = { env = { PYFLAKES_BUILTINS = "_" }, cmd = "pyflakes rayforge tests" }
pyright = "pyright"
lint = { depends-on = ["flake", "pyflakes", "pyright"] }
format = "ruff format rayforge tests scripts"
update-translations = "bash scripts/update_translations.sh"
compile-translations = "bash scripts/update_translations.sh --compile-only"
print-untranslated = "bash scripts/print_untranslated.sh"
list-supporters = "python3 scripts/media/fetch_patreon_supporters.py"

[tasks.clean]
cmd = "find . -type d \\( -name __pycache__ -o -name \"*.egg-info\" \\) -print0 | xargs -0 rm -rf"

[tasks.rayforge]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "scripts/with_gdk.sh rayforge"

[tasks.testapp]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "scripts/with_gdk.sh"

[tasks.test]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "pytest -v --ignore=tests/ui_gtk"

[tasks.uitest]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0):/usr/lib/x86_64-linux-gnu/girepository-1.0"}
cmd = "pytest -v -m ui"

[tasks.screenshot]
env = { GI_TYPELIB_PATH = "$(pkgconf --variable=typelibdir gobject-introspection-1.0)"}
cmd = "scripts/with_gdk.sh scripts/screenshot/cli.py"

[tasks.wheel]
cmd = "python3 -m build"
depends-on = ["compile-translations"]

[tasks.build-deb]
# Builds a binary .deb package for local installation and testing.
cmd = "bash scripts/build-deb.sh"
depends-on = ["compile-translations"]

[tasks.build-deb-source]
# Builds a source package, ready for upload to a PPA.
cmd = "bash scripts/build-deb.sh --source"
depends-on = ["compile-translations"]

# Tasks for developing and generating the website
[feature.website.tasks]
site-install = { cmd = "npm install", cwd = "website" }
site-serve = { cmd = "npm start", cwd = "website" }
site-build = { cmd = "npm run build", cwd = "website" }
site-deploy = "bash scripts/deploy_website.sh"

# Tasks for video processing
[feature.video-tools.tasks]
process-audio = "python3 scripts/media/process_audio.py"
remove-silence = "python3 scripts/media/remove_video_silence.py"
generate-blender-setup = "bash scripts/media/run_blender_setup.sh"
generate-thumbnail = "python3 scripts/media/generate_thumbnail.py"
